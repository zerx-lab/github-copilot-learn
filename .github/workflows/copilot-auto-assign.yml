name: 自动分配 Issue 给 Copilot

on:
  issues:
    types: [opened]

jobs:
  assign-to-copilot:
    runs-on: ubuntu-latest

    permissions:
      issues: write
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: 获取 Copilot Bot ID 并分配 Issue
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
        run: |
          # 1. 检查 Copilot 是否启用并获取 Bot ID
          echo "正在检查 Copilot coding agent 是否启用..."

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -H "GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection" \
            https://api.github.com/graphql \
            -d '{
              "query": "query { repository(owner: \"${{ github.repository_owner }}\", name: \"${{ github.event.repository.name }}\") { id suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) { nodes { login __typename ... on Bot { id } } } } }"
            }')

          echo "API Response: $RESPONSE"

          # 提取 Copilot Bot ID
          BOT_ID=$(echo "$RESPONSE" | jq -r '.data.repository.suggestedActors.nodes[] | select(.login == "copilot-swe-agent") | .id')
          REPO_ID=$(echo "$RESPONSE" | jq -r '.data.repository.id')

          if [ -z "$BOT_ID" ] || [ "$BOT_ID" == "null" ]; then
            echo "错误: Copilot coding agent 未在此仓库启用或无法获取 Bot ID"
            echo "请确保在仓库设置中启用了 Copilot coding agent"
            exit 1
          fi

          echo "找到 Copilot Bot ID: $BOT_ID"
          echo "仓库 ID: $REPO_ID"

          # 2. 获取 Issue 的 GraphQL ID
          ISSUE_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            https://api.github.com/graphql \
            -d '{
              "query": "query { repository(owner: \"${{ github.repository_owner }}\", name: \"${{ github.event.repository.name }}\") { issue(number: ${{ github.event.issue.number }}) { id title } } }"
            }')

          echo "Issue Response: $ISSUE_RESPONSE"

          ISSUE_ID=$(echo "$ISSUE_RESPONSE" | jq -r '.data.repository.issue.id')

          if [ -z "$ISSUE_ID" ] || [ "$ISSUE_ID" == "null" ]; then
            echo "错误: 无法获取 Issue ID"
            exit 1
          fi

          echo "Issue ID: $ISSUE_ID"

          # 3. 使用 GraphQL mutation 分配 Issue 给 Copilot
          echo "正在分配 Issue #${{ github.event.issue.number }} 给 Copilot..."

          ASSIGN_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -H "GraphQL-Features: issues_copilot_assignment_api_support,coding_agent_model_selection" \
            https://api.github.com/graphql \
            -d "{
              \"query\": \"mutation { replaceActorsForAssignable(input: { assignableId: \\\"$ISSUE_ID\\\", actorIds: [\\\"$BOT_ID\\\"], agentAssignment: { targetRepositoryId: \\\"$REPO_ID\\\", baseRef: \\\"main\\\" } }) { assignable { ... on Issue { id title assignees(first: 10) { nodes { login } } } } } }\"
            }")

          echo "分配结果: $ASSIGN_RESPONSE"

          # 检查是否成功
          ASSIGNED=$(echo "$ASSIGN_RESPONSE" | jq -r '.data.replaceActorsForAssignable.assignable.assignees.nodes[].login' 2>/dev/null)

          if echo "$ASSIGNED" | grep -q "copilot-swe-agent"; then
            echo "✅ 成功将 Issue #${{ github.event.issue.number }} 分配给 Copilot!"
          else
            echo "⚠️ 分配可能未成功，请检查上面的响应"
            echo "错误信息: $(echo "$ASSIGN_RESPONSE" | jq -r '.errors')"
          fi
